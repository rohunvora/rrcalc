<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Units Calculator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 17px;
      line-height: 1.47059;
      font-weight: 400;
      letter-spacing: -0.022em;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
      padding-bottom: 200px;
    }

    .container {
      max-width: 980px;
      margin: 0 auto;
      padding: 60px 22px 0;
    }

    .hero {
      text-align: center;
      margin-bottom: 80px;
    }

    .hero h1 {
      font-size: 56px;
      line-height: 1.07143;
      font-weight: 600;
      letter-spacing: -0.005em;
      color: #1d1d1f;
      margin-bottom: 12px;
    }

    .hero p {
      font-size: 28px;
      line-height: 1.14286;
      font-weight: 400;
      letter-spacing: .007em;
      color: #86868b;
      margin-bottom: 40px;
    }

    .main-card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1), 0 8px 32px rgba(0,0,0,0.05);
      padding: 48px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }

    .main-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #007AFF, #5856D6, #AF52DE, #FF2D92, #FF3B30, #FF9500, #FFCC02, #34C759, #32D74B, #007AFF);
      opacity: 0.8;
    }

    .input-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 48px;
    }

    .input-group {
      position: relative;
    }

    .input-group.full {
      grid-column: 1 / -1;
    }

    .input-label {
      display: block;
      font-size: 17px;
      line-height: 1.47059;
      font-weight: 600;
      color: #1d1d1f;
      margin-bottom: 8px;
    }

    .input-field {
      width: 100%;
      height: 56px;
      background: #f6f6f6;
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 0 16px;
      font-size: 17px;
      line-height: 1.47059;
      color: #1d1d1f;
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      outline: none;
      font-weight: 400;
    }

    .input-field:focus {
      background: #ffffff;
      border-color: #007AFF;
      box-shadow: 0 0 0 4px rgba(0,122,255,0.1);
    }

    .input-field::placeholder {
      color: #86868b;
      font-weight: 400;
    }

    .input-hint {
      font-size: 14px;
      line-height: 1.42857;
      color: #86868b;
      margin-top: 6px;
      font-weight: 400;
    }

    .chips-container {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 24px;
    }

    .chip {
      background: #f6f6f6;
      border: 2px solid transparent;
      border-radius: 20px;
      padding: 8px 16px;
      font-size: 15px;
      font-weight: 500;
      color: #1d1d1f;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
      min-height: 44px;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chip:hover {
      background: #e5e5e7;
      transform: scale(1.05);
    }

    .chip:active {
      background: #d2d2d7;
      transform: scale(0.98);
    }

    .confidence-section {
      background: #f6f6f6;
      border-radius: 16px;
      padding: 32px;
      margin: 32px 0;
    }

    .confidence-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .confidence-title {
      font-size: 22px;
      line-height: 1.36364;
      font-weight: 600;
      color: #1d1d1f;
    }

    .confidence-value {
      font-size: 32px;
      line-height: 1.125;
      font-weight: 600;
      color: #007AFF;
      font-variant-numeric: tabular-nums;
    }

    .slider-container {
      position: relative;
      margin: 24px 0;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: #d2d2d7;
      outline: none;
      border-radius: 3px;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #007AFF;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,122,255,0.3);
      transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 16px rgba(0,122,255,0.4);
    }

    .slider::-moz-range-thumb {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #007AFF;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0,122,255,0.3);
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      font-size: 14px;
      color: #86868b;
      font-weight: 500;
    }

    .breakeven-btn {
      background: none;
      border: none;
      color: #007AFF;
      font-size: 17px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 0;
      text-decoration: none;
      transition: opacity 0.2s ease;
    }

    .breakeven-btn:hover {
      opacity: 0.7;
    }

    /* Units recommendation */
    .units-recommendation {
      background: linear-gradient(135deg, #007AFF, #5856D6);
      border-radius: 16px;
      padding: 32px;
      margin: 32px 0;
      text-align: center;
      color: white;
    }

    .units-visual {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 24px;
    }

    .unit-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .unit-dot.active {
      background: white;
      transform: scale(1.3);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.5);
    }

    .units-number {
      font-size: 72px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 8px;
      font-variant-numeric: tabular-nums;
    }

    .units-label {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 16px;
      opacity: 0.95;
    }

    .units-dollar {
      font-size: 32px;
      font-weight: 600;
      margin-bottom: 8px;
      font-variant-numeric: tabular-nums;
    }

    .units-detail {
      font-size: 17px;
      opacity: 0.9;
    }

    .units-recommendation.zero {
      background: #86868b;
    }

    .units-recommendation.one {
      background: linear-gradient(135deg, #FF9500, #FF6200);
    }

    .units-recommendation.two {
      background: linear-gradient(135deg, #007AFF, #5856D6);
    }

    .units-recommendation.three {
      background: linear-gradient(135deg, #34C759, #30D158);
    }

    .results-card {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0,0,0,0.1);
      padding: 32px 22px calc(32px + env(safe-area-inset-bottom));
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
      z-index: 1000;
    }

    .results-card.visible {
      transform: translateY(0);
    }

    .results-content {
      max-width: 980px;
      margin: 0 auto;
    }

    .verdict {
      text-align: center;
      margin-bottom: 24px;
    }

    .verdict-amount {
      font-size: 48px;
      line-height: 1.08333;
      font-weight: 600;
      margin-bottom: 8px;
      font-variant-numeric: tabular-nums;
    }

    .verdict-amount.positive {
      color: #34C759;
    }

    .verdict-amount.negative {
      color: #FF3B30;
    }

    .verdict-amount.neutral {
      color: #FF9500;
    }

    .verdict-label {
      font-size: 19px;
      line-height: 1.26316;
      font-weight: 500;
      color: #86868b;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 24px;
      text-align: center;
    }

    .metric {
      background: #f6f6f6;
      border-radius: 12px;
      padding: 16px;
    }

    .metric-label {
      font-size: 14px;
      color: #86868b;
      font-weight: 500;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .footnote {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: #86868b;
      font-weight: 400;
      line-height: 1.42857;
    }

    @media (max-width: 768px) {
      .container {
        padding: 40px 16px 0;
      }

      .hero h1 {
        font-size: 40px;
      }

      .hero p {
        font-size: 21px;
      }

      .main-card {
        padding: 32px 24px;
      }

      .input-section {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .confidence-section {
        padding: 24px;
      }

      .units-recommendation {
        padding: 24px;
      }

      .units-number {
        font-size: 56px;
      }

      .units-dollar {
        font-size: 28px;
      }

      .results-card {
        padding: 24px 16px calc(24px + env(safe-area-inset-bottom));
      }
    }

    @media (max-width: 480px) {
      .hero h1 {
        font-size: 32px;
      }

      .hero p {
        font-size: 19px;
      }

      .chips-container {
        flex-wrap: wrap;
      }

      .units-number {
        font-size: 48px;
      }

      .units-label {
        font-size: 20px;
      }

      .units-dollar {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1>How many units?</h1>
      <p>0 = Skip. 1 = Small. 2 = Standard. 3 = Max.</p>
    </div>

    <div class="main-card">
      <div class="input-section">
        <div class="input-group">
          <label class="input-label" for="entry">Entry Market Cap</label>
          <input type="text" id="entry" class="input-field" placeholder="2.3M" autocomplete="off" />
          <div class="input-hint">Where you'd buy</div>
        </div>
        
        <div class="input-group">
          <label class="input-label" for="target">Target Market Cap</label>
          <input type="text" id="target" class="input-field" placeholder="10M" autocomplete="off" />
          <div class="input-hint">Where you'd be happy to sell</div>
        </div>

        <div class="input-group">
          <label class="input-label" for="bankroll">Total Bankroll</label>
          <input type="text" id="bankroll" class="input-field" placeholder="50k" autocomplete="off" />
          <div class="input-hint">Your total trading capital</div>
        </div>
        
        <div class="input-group">
          <label class="input-label" for="maxLoss">Max Loss</label>
          <input type="number" id="maxLoss" class="input-field" placeholder="25" min="0" max="95" />
          <div class="input-hint">What you're okay losing (% of position)</div>
        </div>
      </div>

      <div class="chips-container">
        <button class="chip" data-multiplier="2">×2</button>
        <button class="chip" data-multiplier="5">×5</button>
        <button class="chip" data-multiplier="10">×10</button>
        <button class="chip" data-multiplier="50">×50</button>
      </div>

      <div class="confidence-section">
        <div class="confidence-header">
          <span class="confidence-title">Chance it reaches target</span>
          <span class="confidence-value" id="confidence-display">20%</span>
        </div>
        
        <div class="slider-container">
          <input type="range" id="confidence" class="slider" min="5" max="50" value="20" step="1" />
          <div class="slider-labels">
            <span>😰 5%</span>
            <span>25%</span>
            <span>50% 🚀</span>
          </div>
        </div>
        
        <div style="text-align: center; margin-top: 16px;">
          <button class="breakeven-btn" id="setBreakeven">Set to breakeven</button>
        </div>
      </div>

      <!-- Units Recommendation -->
      <div class="units-recommendation zero" id="unitsRec" style="display: none;">
        <div class="units-visual">
          <div class="unit-dot" id="dot1"></div>
          <div class="unit-dot" id="dot2"></div>
          <div class="unit-dot" id="dot3"></div>
        </div>
        <div class="units-number" id="units-number">0</div>
        <div class="units-label" id="units-label">units</div>
        <div class="units-dollar" id="units-dollar">$0</div>
        <div class="units-detail" id="units-detail">Each unit = $0 (0.5% of bankroll)</div>
      </div>
    </div>
  </div>

  <div class="results-card" id="resultsCard">
    <div class="results-content">
      <div class="verdict">
        <div class="verdict-amount" id="ev-amount">$0</div>
        <div class="verdict-label" id="ev-label">Enter values above</div>
      </div>
      
      <div class="metrics">
        <div class="metric">
          <div class="metric-label">EV %</div>
          <div class="metric-value" id="ev-percent">0%</div>
        </div>
        <div class="metric">
          <div class="metric-label">R Multiple</div>
          <div class="metric-value" id="r-multiple">0.0R</div>
        </div>
        <div class="metric">
          <div class="metric-label">Upside</div>
          <div class="metric-value" id="upside">+$0</div>
        </div>
        <div class="metric">
          <div class="metric-label">Downside</div>
          <div class="metric-value" id="downside">-$0</div>
        </div>
      </div>
      
      <div class="footnote">
        Units system: 0.5% per unit, max 3 units. Based on quarter-Kelly for safety.
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const UNIT_PERCENT = 0.005;  // 0.5% of bankroll per unit
    const MAX_UNITS = 3;         // Maximum units allowed
    
    // Utility
    const $ = id => document.getElementById(id);
    
    // DOM elements
    const entry = $('entry');
    const target = $('target');
    const bankroll = $('bankroll');
    const maxLoss = $('maxLoss');
    const confidence = $('confidence');
    const confidenceDisplay = $('confidence-display');
    const setBreakevenBtn = $('setBreakeven');
    const resultsCard = $('resultsCard');
    const unitsRec = $('unitsRec');
    const unitsNumber = $('units-number');
    const unitsLabel = $('units-label');
    const unitsDollar = $('units-dollar');
    const unitsDetail = $('units-detail');
    const dot1 = $('dot1');
    const dot2 = $('dot2');
    const dot3 = $('dot3');
    const evAmount = $('ev-amount');
    const evLabel = $('ev-label');
    const evPercent = $('ev-percent');
    const rMultiple = $('r-multiple');
    const upside = $('upside');
    const downside = $('downside');

    let currentBreakeven = 0;

    // Parse shorthand (2.3M, 500k, etc)
    function parseShorthand(value) {
      if (!value) return 0;
      value = value.toString().replace(/,/g, '');
      const upperValue = value.toUpperCase();
      if (upperValue.endsWith('K')) {
        return parseFloat(value) * 1000;
      } else if (upperValue.endsWith('M')) {
        return parseFloat(value) * 1000000;
      } else if (upperValue.endsWith('B')) {
        return parseFloat(value) * 1000000000;
      }
      return parseFloat(value) || 0;
    }

    // Format numbers for display
    function formatNumber(value) {
      const abs = Math.abs(value);
      if (abs >= 1000) {
        return value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      } else if (abs >= 100) {
        return value.toFixed(0);
      } else if (abs >= 10) {
        return value.toFixed(1);
      } else {
        return value.toFixed(2);
      }
    }

    // Main calculation with units sizing
    function calculate() {
      const entryMC = parseShorthand(entry.value);
      const targetMC = parseShorthand(target.value);
      const bankrollAmount = parseShorthand(bankroll.value);
      const maxLossPct = parseFloat(maxLoss.value) || 25;
      const conf = parseFloat(confidence.value) / 100;

      const hasMinimumInputs = entryMC > 0 && targetMC > 0 && bankrollAmount > 0;

      if (!hasMinimumInputs) {
        resultsCard.classList.remove('visible');
        unitsRec.style.display = 'none';
        evAmount.textContent = '$0';
        evLabel.textContent = 'Enter values above';
        evPercent.textContent = '0%';
        rMultiple.textContent = '0.0R';
        upside.textContent = '+$0';
        downside.textContent = '-$0';
        currentBreakeven = 0;
        return;
      }

      // Calculate optimal position size using Kelly criterion
      const multiple = targetMC / entryMC;
      const potentialGainMultiple = Math.max(0, multiple - 1);
      const lossMultiple = maxLossPct / 100;
      
      // Risk/Reward ratio (b in Kelly formula)
      const b = lossMultiple > 0 ? (potentialGainMultiple / lossMultiple) : 0;
      
      // Kelly fraction: f = (p*b - q) / b
      const p = conf;
      const q = 1 - conf;
      let kellyFraction = b > 0 ? (p * b - q) / b : 0;
      
      // Use quarter-Kelly for safety
      kellyFraction = Math.max(0, kellyFraction) * 0.25;
      
      // Convert Kelly to units
      const unitSize = bankrollAmount * UNIT_PERCENT;
      let units = Math.round(kellyFraction / UNIT_PERCENT);
      
      // Cap at max units
      units = Math.min(MAX_UNITS, Math.max(0, units));
      
      // Calculate position from units
      const positionSize = units * unitSize;
      
      // Calculate metrics based on position
      const upsideAmount = positionSize * potentialGainMultiple;
      const downsideAmount = positionSize * lossMultiple;
      const R = downsideAmount > 0 ? (upsideAmount / downsideAmount) : 0;
      const ev = (conf * upsideAmount) - ((1 - conf) * downsideAmount);
      const evPct = positionSize > 0 ? (ev / positionSize) : 0;

      // If EV is negative, force to 0 units
      if (ev <= 0) {
        units = 0;
      }

      // Recalculate with final units
      const finalPosition = units * unitSize;
      const finalUpside = finalPosition * potentialGainMultiple;
      const finalDownside = finalPosition * lossMultiple;
      const finalEV = (conf * finalUpside) - ((1 - conf) * finalDownside);
      const finalEVPct = finalPosition > 0 ? (finalEV / finalPosition) : 0;

      currentBreakeven = (finalUpside + finalDownside) > 0 ? 
        finalDownside / (finalUpside + finalDownside) : 0;

      // Show units recommendation
      unitsRec.style.display = 'block';
      resultsCard.classList.add('visible');

      // Update units display
      unitsNumber.textContent = units.toString();
      unitsLabel.textContent = units === 1 ? 'unit' : 'units';
      unitsDollar.textContent = `$${formatNumber(finalPosition)}`;
      unitsDetail.textContent = `Each unit = $${formatNumber(unitSize)} (${(UNIT_PERCENT*100).toFixed(1)}% of bankroll)`;

      // Update unit dots
      dot1.classList.toggle('active', units >= 1);
      dot2.classList.toggle('active', units >= 2);
      dot3.classList.toggle('active', units >= 3);

      // Update units card color
      unitsRec.className = 'units-recommendation';
      if (units === 0) {
        unitsRec.classList.add('zero');
      } else if (units === 1) {
        unitsRec.classList.add('one');
      } else if (units === 2) {
        unitsRec.classList.add('two');
      } else if (units === 3) {
        unitsRec.classList.add('three');
      }

      // Determine verdict
      let verdictClass, verdictText;
      if (units === 0) {
        verdictClass = 'negative';
        verdictText = 'Skip this trade. Negative expected value.';
      } else if (units === 3) {
        verdictClass = 'positive';
        verdictText = `Maximum conviction. Risk ${units} units.`;
      } else if (units === 2) {
        verdictClass = 'positive';
        verdictText = `Standard position. Risk ${units} units.`;
      } else if (units === 1) {
        verdictClass = 'neutral';
        verdictText = `Small position. Risk ${units} unit.`;
      }

      // Update display
      evAmount.textContent = `${finalEV >= 0 ? '+' : ''}$${formatNumber(finalEV)}`;
      evAmount.className = `verdict-amount ${verdictClass}`;
      evLabel.textContent = verdictText;
      
      evPercent.textContent = `${(finalEVPct * 100).toFixed(1)}%`;
      evPercent.style.color = finalEV >= 0 ? '#34C759' : '#FF3B30';
      
      rMultiple.textContent = `${R.toFixed(1)}R`;
      rMultiple.style.color = R >= 2 ? '#34C759' : R >= 1.5 ? '#FF9500' : '#FF3B30';
      
      upside.textContent = `+$${formatNumber(finalUpside)}`;
      upside.style.color = '#34C759';
      
      downside.textContent = `-$${formatNumber(finalDownside)}`;
      downside.style.color = '#FF3B30';
    }

    // Event listeners
    confidence.addEventListener('input', (e) => {
      confidenceDisplay.textContent = e.target.value + '%';
      calculate();
    });

    [entry, target, bankroll, maxLoss].forEach(input => {
      input.addEventListener('input', calculate);
      input.addEventListener('focus', () => {
        setTimeout(() => input.select(), 0);
      });
    });

    // Multiplier chips
    document.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const multiplier = parseFloat(chip.dataset.multiplier);
        const entryMC = parseShorthand(entry.value);
        if (entryMC > 0) {
          const targetMC = entryMC * multiplier;
          if (targetMC >= 1000000) {
            target.value = (targetMC / 1000000).toFixed(1).replace('.0', '') + 'M';
          } else if (targetMC >= 1000) {
            target.value = (targetMC / 1000).toFixed(0) + 'k';
          } else {
            target.value = targetMC.toString();
          }
          calculate();
        }
      });
    });

    // Set to breakeven
    setBreakevenBtn.addEventListener('click', () => {
      if (currentBreakeven > 0) {
        const breakevenPct = Math.round(currentBreakeven * 100);
        confidence.value = Math.min(50, Math.max(5, breakevenPct));
        confidenceDisplay.textContent = confidence.value + '%';
        calculate();
      }
    });

    // Initialize
    calculate();
  </script>
</body>
</html>
